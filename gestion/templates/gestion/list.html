{% extends "gestion/base.html" %}

{% load i18n static %}

{% block title %}Listado de miembros{% endblock %}

{% block content %}
<div class="wrapper">
  {% include "gestion/sidebar.html" %}
  <div class="main-panel">
    <div class="content">
      <div class="container-fluid">
        <div class="navbar-minimize">
          <button id="minimizeSidebar" class="btn btn-round btn-white btn-fill btn-just-icon">
            <i class="material-icons visible-on-sidebar-regular">more_vert</i>
            <i class="material-icons visible-on-sidebar-mini">view_list</i>
            <div class="ripple-container"></div>
          </button>

          <div class="pull-right">
            <span
              ><a href="/" class="card-title text-primary"> <b> Miembros</b></a> -
            </span>
            <span><a href="/cargos" class="card-title text-primary"> Cargos de responsabilidad</a> - </span>
            <span><a href="/cargos_capacitacion" class="card-title text-primary"> Cargos de capacitación</a></span>
          </div>
          <div>
            <div class="row">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-content">
                    {% if request.user.is_nacional %}
                    <div class="pull-right">
                      <input type="checkbox" id="checkboxSinGrupo" /> Sin grupo
                      <span class="dropdown" style="margin-left: 2rem">
                        <button
                          href="#"
                          class="dropdown-toggle btn btn-primary btn-round"
                          data-toggle="dropdown"
                          aria-expanded="true"
                          id="estadoButton"
                        >
                          Estado <b class="caret"></b>
                          <div class="ripple-container"></div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-left">
                          <li>
                            <div class="radio">
                              <label
                                ><input
                                  type="radio"
                                  name="estadoradio"
                                  id="estadoRadioTodos"
                                  value="todos"
                                />Todos</label
                              >
                            </div>
                          </li>
                          <li>
                            <div class="radio">
                              <label
                                ><input
                                  type="radio"
                                  name="estadoradio"
                                  id="estadoRadioActivos"
                                  value="activos"
                                  checked
                                />
                                Sólo activos</label
                              >
                            </div>
                          </li>
                          <li>
                            <div class="radio">
                              <label
                                ><input type="radio" name="estadoradio" id="estadoRadioBajas" value="bajas" /> Sólo
                                bajas</label
                              >
                            </div>
                          </li>
                        </ul>
                      </span>
                    </div>
                    {% endif %}
                    <h4 class="card-title text-primary">
                      <b>Miembros{% if nivel %} filtrados de {{ nivel }} {{ nombre_nivel }}{% endif %}</b>{% if nivel %}
                      <a href="/">(quitar)</a>{% endif %}
                    </h4>
                    <div class="toolbar">Cargando...</div>
                    <div class="material-datatables">
                      <table
                        id="datatables"
                        class="table table-striped table-no-bordered table-hover"
                        cellspacing="0"
                        width="100%"
                        style="width: 100%"
                      >
                        <thead>
                          <tr>
                            <th>Nombre</th>
                            <th>Apellidos</th>
                            <th>Departamento</th>
                            <th>Teléfono móvil</th>
                            <th>Correo electrónico</th>
                            <th>Región</th>
                            <th>Zona</th>
                            <th>Distrito General</th>
                            <th>Distrito</th>
                            <th>Grupo</th>
                            <th>Localidad</th>
                            <th>Fecha baja</th>
                            <th>Fecha nacimiento</th>
                            <th>Estudio</th>
                            <th>Fecha estudio</th>
                            <th>Fecha ingreso SG</th>
                            <th>Motivo alta</th>
                            <th>Motivo baja</th>
                            <th>Omamori Gohonzon</th>
                            <th>Fecha Omamori Gohonzon</th>
                            <th>Código postal</th>
                            <th>Núm. cargos</th>
                            <th>Núm. cargos capacitación</th>
                            <th>DNI</th>
                            <th>Fecha Gohonzon</th>
                            <th>Fecha incorporación SGES</th>
                            <th>Procedencia</th>
                            <th>Destino</th>
                            <th>Activo</th>
                            <th>TSalta</th>
                            <th>TSaltaex</th>
                            <th>TSbaja</th>
                          </tr>
                        </thead>
                        <tfoot>
                          <tr>
                            <th>Nombre</th>
                            <th>Apellidos</th>
                            <th>Departamento</th>
                            <th>Teléfono móvil</th>
                            <th>Correo electrónico</th>
                            <th>Región</th>
                            <th>Zona</th>
                            <th>Distrito General</th>
                            <th>Distrito</th>
                            <th>Grupo</th>
                            <th>Localidad</th>
                            <th>Fecha baja</th>
                            <th>Fecha nacimiento</th>
                            <th>Estudio</th>
                            <th>Fecha estudio</th>
                            <th>Fecha ingreso SG</th>
                            <th>Motivo alta</th>
                            <th>Motivo baja</th>
                            <th>Omamori Gohonzon</th>
                            <th>Fecha Omamori Gohonzon</th>
                            <th>Código postal</th>
                            <th>Núm. cargos</th>
                            <th>Núm. cargos capacitación</th>
                            <th>DNI</th>
                            <th>Fecha Gohonzon</th>
                            <th>Fecha incorporación SGES</th>
                            <th>Procedencia</th>
                            <th>Destino</th>
                            <th>Activo</th>
                            <th>TSalta</th>
                            <th>TSaltaex</th>
                            <th>TSbaja</th>
                          </tr>
                        </tfoot>
                        <tbody>
                          {% for member in members %}
                          <tr>
                            <td class="text-center">
                              <a class="text-primary" href="member/{{ member.id }}">{{ member.nombre|default:"-"}}</a>
                            </td>
                            <td class="text-center">
                              <a class="text-primary" href="member/{{ member.id }}">{{ member.apellidos|default:"-"}}</a>
                            </td>
                            <td class="text-center">{{ member.departamento|default:"-" }}</td>
                            <td class="text-center">{{ member.movil|default:"-" }}</td>
                            <td class="text-center">{{ member.email|default:"-" }}</td>
                            <td class="text-center">{{ member.region|default:"-" }}</td>
                            <td class="text-center">{{ member.zona|default:"-" }}</td>
                            <td class="text-center">{{ member.distrito_general|default:"-" }}</td>
                            <td class="text-center">{{ member.distrito|default:"-" }}</td>
                            <td class="text-center">{{ member.grupo|default:"-" }}</td>
                            <td class="text-center">{{ member.localidad|default:"-" }}</td>
                            <td class="text-center">{{ member.fechab|default:"-" }}</td>
                            <td class="text-center">{{ member.fecha_nacimiento|default:"-" }}</td>
                            <td class="text-center">{{ member.estudio|default:"Sin estudio" }}</td>
                            <td class="text-center">{{ member.fecha_estudio|default:"-" }}</td>
                            <td class="text-center">{{ member.fechaa|default:"-" }}</td>
                            <td class="text-center">{{ member.motivo_alta|default:"-" }}</td>
                            <td class="text-center">{{ member.motivo_baja|default:"-" }}</td>
                            <td class="text-center">{% if member.omamori_gohonzon %}Sí{% else %}No{% endif %}</td>
                            <td class="text-center">{{ member.omamori_fecha|default:"-" }}</td>
                            <td class="text-center">{{ member.codigo_postal|default:"-" }}</td>
                            <td class="text-center">{{ member.num_cargos|default:"0" }}</td>
                            <td class="text-center">{{ member.num_cargos_capacitacion|default:"0" }}</td>
                            <td class="text-center">{{ member.dni|default:"-" }}</td>
                            <td class="text-center">{{ member.gohonzon|default:"-" }}</td>
                            <td class="text-center">{{ member.fecha_llegada_extranjero|default:"-" }}</td>
                            <td class="text-center">{{ member.procedencia|default:"-" }}</td>
                            <td class="text-center">{{ member.destino|default:"-" }}</td>
                            <td class="text-center">{% if not member.fechab %}&#9989;{% else %}&#10060;{% endif %}</td>
                            <td class="text-center">{{ member.timestampalta|default:"-" }}</td>
                            <td class="text-center">{{ member.timestampbaja|default:"-" }}</td>
                            <td class="text-center">{{ member.timestampaltaex|default:"-" }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <!-- end content-->
                </div>
                <!--  end card  -->
              </div>
              <!-- end col-md-12 -->
            </div>
            <!-- end row -->
          </div>
        </div>
      </div>
    </div>
    {% endblock %}
	
	{% block scripts %}
    <script>
      $(document).ready(function () {
        function get_estructura(id, field, child, input) {
          $.getJSON("/getEstructura/", { id: id, field: field, child: child }, function (j) {
            var options = '<option value="">---------</option>';
            for (var i = 0; i < j.length; i++) {
              options += '<option value="' + j[i][0] + '">' + j[i][1] + "</option>";
            }
            // inspect html to check id of subcategory select dropdown.
            input.html(options);
          });
        }

        $(".toggle-vis").prop("checked", true);

        $("[data-column=11]").prop("checked", false);
        $("[data-column=12]").prop("checked", false);
        $("[data-column=13]").prop("checked", false);
        $("[data-column=14]").prop("checked", false);
        $("[data-column=15]").prop("checked", false);
        $("[data-column=16]").prop("checked", false);
        $("[data-column=17]").prop("checked", false);
        $("[data-column=18]").prop("checked", false);
        $("[data-column=19]").prop("checked", false);
        $("[data-column=20]").prop("checked", false);
        $("[data-column=21]").prop("checked", false);
        $("[data-column=22]").prop("checked", false);
        $("[data-column=24]").prop("checked", false);
        $("[data-column=25]").prop("checked", false);
        $("[data-column=26]").prop("checked", false);
        $("[data-column=27]").prop("checked", false);
        $("[data-column=29]").prop("checked", false);
        $("[data-column=30]").prop("checked", false);
        $("[data-column=31]").prop("checked", false);

        function filterGlobal() {
          $("#datatables")
            .DataTable()
            .search($("#global_filter").val(), $("#global_regex").prop("checked"), $("#global_smart").prop("checked"))
            .draw();
        }

        function filterColumn(i) {
          $("#datatables")
            .DataTable()
            .column(i)
            .search(
              $("#col" + i + "_filter").val(),
              $("#col" + i + "_regex").prop("checked"),
              $("#col" + i + "_smart").prop("checked")
            )
            .draw();
        }

        const idFechaBajaColumn = 11;

        $("#estadoRadioTodos").on("click", function () {
          table.column(idFechaBajaColumn).search("").draw();
          $("#estadoButton").text("Todos");
        });

        $("#estadoRadioActivos").on("click", function () {
          table.column(idFechaBajaColumn).search("-", true).draw();
          $("#estadoButton").text("Sólo activos");
        });

        $("#estadoRadioBajas").on("click", function () {
          table.column(idFechaBajaColumn).search("[^-]", true, false).draw();
          $("#estadoButton").text("Sólo bajas");
        });

        $("#checkboxSinGrupo").on("click", function () {
          if ($(this).is(":checked")) {
            table.column(9).search("^-$", true, false).draw();
          } else {
            table.column(9).search("").draw();
          }
        });

        $.fn.dataTable.ext.order.intl("es");

        var table = $("#datatables").DataTable({
          dom: "lBfrtip",
          buttons: ["copy", "csv", "excel", "print"],
          order: [[2, "desc"]],
          pagingType: "full_numbers",
          lengthMenu: [
            [10, 20, 50, -1],
            [10, 20, 50, "Todos"],
          ],
          search: {
            regex: true,
            caseInsensitive: true,
          },
          bRetrieve: true,
          responsive: true,
          language: {
            sProcessing: "Procesando...",
            sLengthMenu: "Mostrar _MENU_ registros",
            sZeroRecords: "No se encontraron resultados",
            sEmptyTable: "Ningún dato disponible en esta tabla",
            sInfo: "Registros _START_ al _END_ de _TOTAL_",
            sInfoEmpty: "Registros 0 al 0 de 0",
            sInfoFiltered: "(filtrado)",
            sInfoPostFix: "",
            sSearch: "Buscar",
            sUrl: "",
            sInfoThousands: ".",
            sLoadingRecords: "Cargando...",
            oPaginate: {
              sFirst: "Primero",
              sLast: "Último",
              sNext: "Siguiente",
              sPrevious: "Anterior",
            },
            oAria: {
              sSortAscending: ": Activar para ordenar la columna de manera ascendente",
              sSortDescending: ": Activar para ordenar la columna de manera descendente",
            },
          },
          initComplete: function (settings, json) {
            $("#datatables").show();
            $(".toolbar").hide();
          },
        });

        table.columns([11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 24, 25, 26, 27, 29, 30, 31]).visible(false);

        function aplicarFiltroInicial() {
          // La tabla se inicia filtrada por sólo los activos
          $("#estadoRadioActivos").trigger("click");

          // Los selectores de estructura de región y zona se marcan automáticamente para los RER y REZ
          // Si sólo hay una opción, marcarla automáticamente
          //if ($(".regiones-selector").length == 1) {
          //	elegir_zona($(".regiones-selector")[0].text);
          //}
        }
        aplicarFiltroInicial();

        function filtrarTabla(column_number, text) {
          text = $.fn.dataTable.util.escapeRegex(text)
          table                    
            .column(column_number)
            .search(text ? "^" + text + "$" : "", true, false)
            .draw();
        }

        function resetElemento(text, column_number) {
          var htmlContent = '<li class="dropdown-header">Sin ' + text + "</li>";
          $("#" + text + "List").html(htmlContent);
          $("#" + text + "Btn").html(text + ' <b class="caret"></b><div class="ripple-container"></div>');
          $("#reset" + text + "Btn").hide();
          filtrarTabla(column_number, "");
        }

        function elegir_zona(text) {
          resetElemento("zonas", 6);
          resetElemento("DG", 7);
          resetElemento("distritos", 8);
          resetElemento("grupos", 9);
          $("#DGBtn").hide();
          $("#distritosBtn").hide();
          $("#gruposBtn").hide();
          $("#resetRegionesBtn").show();
          $("#resetZonasBtn").hide();
          filtrarTabla(5, text);
          $("#regionesList").html(text + '<b class="caret"></b><div class="ripple-container"></div>');
          rellenarZonas(text);
        }
        // regiones
        $(".regiones-selector").on("click", function () {
          elegir_zona(this.text);
        });

        $("#resetRegionesBtn").on("click", function () {
          resetElemento("zonas", 6);
          resetElemento("DG", 7);
          resetElemento("distritos", 8);
          resetElemento("grupos", 9);

          $("#regionesList").html("REGIONES " + '<b class="caret"></b><div class="ripple-container"></div>');
          $("#resetRegionesBtn").hide();
          filtrarTabla(5, "");
          $("#zonasBtn").hide();
          $("#DGBtn").hide();
          $("#distritosBtn").hide();
          $("#gruposBtn").hide();
        });

        // zonas
        function rellenarZonas(region) {
          $("#zonasBtn").show();
          var zonas = table.column(6, { search: "applied" }).data().unique().sort();
          var htmlContent = '<li class="dropdown-header">Seleccione zona</li>';
          $("#zonasList").html(htmlContent);
          var i;
          for (i = 0; i < zonas.length; i++) {
            element = $('<li><a class="zonas-selector" href="#">' + zonas[i] + "</a></li>");
            element.click(handlerZona);
            $("#zonasList").append(element);
          }
          $("#resetzonasBtn").hide();
          $("#regionesList").close();
        }

        function handlerZona() {
          resetElemento("DG", 7);
          resetElemento("distritos", 8);
          resetElemento("grupos", 9);
          $("#distritosBtn").hide();
          $("#gruposBtn").hide();

          $("#resetzonasBtn").show();
          var val = this.textContent;
          $("#zonasBtn").html(val + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(6, val);
          rellenarDG(val);

          $("#resetDGBtn").hide();
          $("#resetdistritosBtn").hide();
          $("#resetgruposBtn").hide();
        }

        $("#resetzonasBtn").on("click", function () {
          resetElemento("DG", 7);
          resetElemento("distritos", 8);
          resetElemento("grupos", 9);
          $("#zonasBtn").html("ZONAS " + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(6, "");
          $("#resetzonasBtn").hide();
          $("#DGBtn").hide();
          $("#distritosBtn").hide();
          $("#gruposBtn").hide();
        });

        // DG
        function rellenarDG(zona) {
          $("#DGBtn").show();
          var DGs = table.column(7, { search: "applied" }).data().unique().sort();
          var htmlContent = '<li class="dropdown-header">Seleccione DG</li>';
          $("#DGList").html(htmlContent);
          var i;
          for (i = 0; i < DGs.length; i++) {
            element = $('<li><a class="DG-selector" href="#">' + DGs[i] + "</a></li>");
            element.click(handlerDG);
            $("#DGList").append(element);
          }
          $("#resetDGBtn").hide();
        }

        function handlerDG() {
          resetElemento("distritos", 8);
          resetElemento("grupos", 9);
          $("#gruposBtn").hide();

          $("#resetDGBtn").show();
          var val = this.textContent;
          $("#DGBtn").html(val + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(7, val);
          rellenarDistrito(val);

          $("#resetdistritosBtn").hide();
          $("#resetgruposBtn").hide();
        }

        $("#resetDGBtn").on("click", function () {
          resetElemento("distritos", 8);
          resetElemento("grupos", 9);
          $("#DGBtn").html("DG " + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(7, "");
          $("#resetDGBtn").hide();
          $("#distritosBtn").hide();
          $("#gruposBtn").hide();
        });

        // Distrito
        function rellenarDistrito(zona) {
          $("#distritosBtn").show();
          var distritos = table.column(8, { search: "applied" }).data().unique().sort();
          var htmlContent = '<li class="dropdown-header">Seleccione distrito</li>';
          $("#distritosList").html(htmlContent);
          var i;
          for (i = 0; i < distritos.length; i++) {
            element = $('<li><a class="distrito-selector" href="#">' + distritos[i] + "</a></li>");
            element.click(handlerDistrito);
            $("#distritosList").append(element);
          }
          $("#resetdistritosBtn").hide();
        }

        function handlerDistrito() {
          resetElemento("grupos", 9);

          $("#resetdistritosBtn").show();
          var val = this.textContent;
          $("#distritosBtn").html(val + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(8, val);
          rellenarGrupo(val);

          $("#resetgruposBtn").hide();
        }

        $("#resetdistritosBtn").on("click", function () {
          resetElemento("grupos", 9);
          $("#distritosBtn").html("distrito " + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(8, "");
          $("#resetdistritosBtn").hide();
          $("#gruposBtn").hide();
        });

        // Grupo
        function rellenarGrupo(zona) {
          $("#gruposBtn").show();
          var grupos = table.column(9, { search: "applied" }).data().unique().sort();
          var htmlContent = '<li class="dropdown-header">Seleccione grupo</li>';
          $("#gruposList").html(htmlContent);
          var i;
          for (i = 0; i < grupos.length; i++) {
            element = $('<li><a class="grupo-selector" href="#">' + grupos[i] + "</a></li>");
            element.click(handlerGrupo);
            $("#gruposList").append(element);
          }
          $("#resetgruposBtn").hide();
        }

        function handlerGrupo() {
          $("#resetgruposBtn").show();
          var val = this.textContent;
          $("#gruposBtn").html(val + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(9, val);
        }

        $("#resetgruposBtn").on("click", function () {
          $("#gruposBtn").html("grupo " + '<b class="caret"></b><div class="ripple-container"></div>');
          filtrarTabla(9, "");
          $("#resetgruposBtn").hide();
        });

        // Estudios
        $(".estudios-selector").on("click", function () {
          $("#resetEstudiosBtn").show();
          filtrarTabla(13, this.text);
          $("#estudiosList").html(this.text + '<b class="caret"></b><div class="ripple-container"></div>');
        });

        $("#resetEstudiosBtn").on("click", function () {
          $("#estudiosList").html("ESTUDIOS " + '<b class="caret"></b><div class="ripple-container"></div>');
          $("#resetEstudiosBtn").hide();
          filtrarTabla(13, "");
        });

        // Departamento
        $(".departamentos-selector").on("click", function () {
          $("#resetDepartamentosBtn").show();
          filtrarTabla(2, this.text);
          $("#departamentosList").html(this.text + '<b class="caret"></b><div class="ripple-container"></div>');
        });

        $("#resetDepartamentosBtn").on("click", function () {
          $("#departamentosList").html("DEPARTAMENTOS " + '<b class="caret"></b><div class="ripple-container"></div>');
          $("#resetDepartamentosBtn").hide();
          filtrarTabla(2, "");
        });

        // Siendo miembro recibir Gohonzon
        $(".cbGohonzon").on("click", function () {
          /*if ($(this).is(":checked")) {
            console.log("Click");
          } else {
            console.log("Unclick");
          }*/
          table.draw();
        });

        // Motivos alta
        $(".altas-selector").on("click", function () {
          $("#resetAltasBtn").show();
          filtrarTabla(16, this.text);
          $("#altasList").html(this.text + '<b class="caret"></b><div class="ripple-container"></div>');
        });

        $("#resetAltasBtn").on("click", function () {
          $("#altasList").html('MOTIVOS ALTA <b class="caret"></b><div class="ripple-container"></div>');
          $("#resetAltasBtn").hide();
          filtrarTabla(16, "");
        });

        // Motivos baja
        $(".bajas-selector").on("click", function () {
          $("#resetBajasBtn").show();
          filtrarTabla(17, this.text);
          $("#bajasList").html(this.text + '<b class="caret"></b><div class="ripple-container"></div>');
        });

        $("#resetBajasBtn").on("click", function () {
          $("#bajasList").html('MOTIVOS BAJA <b class="caret"></b><div class="ripple-container"></div>');
          $("#resetBajasBtn").hide();
          filtrarTabla(17, "");
        });

        // Omamori Gohonzon
        $(".omamori-selector").on("click", function () {
          $("#resetOmamoriBtn").show();
          filtrarTabla(18, this.text);
          $("#omamoriList").html(this.text + '<b class="caret"></b><div class="ripple-container"></div>');
        });

        $("#resetOmamoriBtn").on("click", function () {
          $("#omamoriList").html('OMAMORI GOHONZON <b class="caret"></b><div class="ripple-container"></div>');
          $("#resetBajasBtn").hide();
          filtrarTabla(18, "");
        });

        $("input.toggle-vis")
          .unbind("click")
          .on("click", function (e) {
            // e.preventDefault();

            // Get the column API object
            var column = table.column($(this).attr("data-column"));
            // Toggle the visibility
            column.visible(!column.visible());
            if (column.visible() == false) {
              $(this).addClass("column-not-visible");
            } else {
              $(this).removeClass("column-not-visible");
            }
          });

        $.fn.dataTableExt.afnFiltering.push(
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fbaini").value;
            var iFfin = document.getElementById("fbafin").value;
            var iStartDateCol = idFechaBajaColumn;
            var iEndDateCol = idFechaBajaColumn;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },

          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fini").value;
            var iFfin = document.getElementById("ffin").value;
            var iStartDateCol = 12;
            var iEndDateCol = 12;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },

          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fesini").value;
            var iFfin = document.getElementById("fesfin").value;
            var iStartDateCol = 14;
            var iEndDateCol = 14;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },

          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("finini").value;
            var iFfin = document.getElementById("finfin").value;
            var iStartDateCol = 15;
            var iEndDateCol = 15;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);
            
            // console.log("filtro inicial: " + iFini + ", dato tabla inicial:" + datofini);
            //console.log("filtro final: " + iFfin + ", dato tabla final:" + datoffin);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },

          // Omamori
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fomini").value;
            var iFfin = document.getElementById("fomfin").value;
            var iStartDateCol = 19;
            var iEndDateCol = 19;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },

          // Código postal
          function (oSettings, aData, iDataIndex) {
            var cpmin = parseInt($("#cpini").val(), 10);
            var cpmax = parseInt($("#cpfin").val(), 10);
            var cp = parseFloat(aData[20]) || 0; // use data for the cp column

            if (
              (isNaN(cpmin) && isNaN(cpmax)) ||
              (isNaN(cpmin) && cp <= cpmax) ||
              (cpmin <= cp && isNaN(cpmax)) ||
              (cpmin <= cp && cp <= cpmax)
            ) {
              return true;
            }
            return false;
          },
          // Fecha incorporación SGEs
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fSGEsini").value;
            var iFfin = document.getElementById("fSGEsfin").value;
            var iStartDateCol = 25;
            var iEndDateCol = 25;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },
          // Fecha Gohonzon
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fgoini").value;
            var iFfin = document.getElementById("fgofin").value;
            var iStartDateCol = 24;
            var iEndDateCol = 24;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var datofini =
              aData[iStartDateCol].substring(6, 10) +
              aData[iStartDateCol].substring(3, 5) +
              aData[iStartDateCol].substring(0, 2);
            var datoffin =
              aData[iEndDateCol].substring(6, 10) +
              aData[iEndDateCol].substring(3, 5) +
              aData[iEndDateCol].substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },
          // Fecha mecanización alta
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fmaini").value;
            var iFfin = document.getElementById("fmafin").value;
            var iStartDateCol = 29;
            var iEndDateCol = 29;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var fechadato = moment(aData[iStartDateCol], 'D [de] MMM [de] YYYY [a las] HH:mm').format("DD/MM/YYYY")
            var datofini =
              fechadato.substring(6, 10) +
              fechadato.substring(3, 5) +
              fechadato.substring(0, 2);

            var fechadato = moment(aData[iStartDateCol], 'D [de] MMM [de] YYYY [a las] HH:mm').format("DD/MM/YYYY")
            var datoffin =
              fechadato.substring(6, 10) +
              fechadato.substring(3, 5) +
              fechadato.substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },
          // Fecha mecanización alta extranjero
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fmaeini").value;
            var iFfin = document.getElementById("fmaefin").value;
            var iStartDateCol = 30;
            var iEndDateCol = 30;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var fechadato = moment(aData[iStartDateCol], 'D [de] MMM [de] YYYY [a las] HH:mm').format("DD/MM/YYYY")
            var datofini =
              fechadato.substring(6, 10) +
              fechadato.substring(3, 5) +
              fechadato.substring(0, 2);

            var fechadato = moment(aData[iStartDateCol], 'D [de] MMM [de] YYYY [a las] HH:mm').format("DD/MM/YYYY")
            var datoffin =
              fechadato.substring(6, 10) +
              fechadato.substring(3, 5) +
              fechadato.substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },
          // Fecha mecanización baja
          function (oSettings, aData, iDataIndex) {
            var iFini = document.getElementById("fmbini").value;
            var iFfin = document.getElementById("fmbfin").value;
            var iStartDateCol = 31;
            var iEndDateCol = 31;

            iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2);
            iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2);

            var fechadato = moment(aData[iStartDateCol], 'D [de] MMM [de] YYYY [a las] HH:mm').format("DD/MM/YYYY")
            var datofini =
              fechadato.substring(6, 10) +
              fechadato.substring(3, 5) +
              fechadato.substring(0, 2);

            var fechadato = moment(aData[iStartDateCol], 'D [de] MMM [de] YYYY [a las] HH:mm').format("DD/MM/YYYY")
            var datoffin =
              fechadato.substring(6, 10) +
              fechadato.substring(3, 5) +
              fechadato.substring(0, 2);

            if (iFini === "" && iFfin === "") {
              return true;
            } else if (iFini <= datofini && iFfin === "") {
              return true;
            } else if (iFfin >= datoffin && iFini === "") {
              return true;
            } else if (iFini <= datofini && iFfin >= datoffin) {
              return true;
            }
            return false;
          },
          // Siendo Miembro recibir Gohonzon
          function (oSettings, aData, iDataIndex) {
            var iFechaAlta = 15;
            var iFechaG = 24;

            var fechaAlta = moment(aData[iFechaAlta], "DD/MM/YYYY")
            var fechaG = moment(aData[iFechaG], "DD/MM/YYYY")
            
            if ($("#cbGohonzon").prop("checked")) {
              if (fechaAlta < fechaG) {
                return true;
              } else {
                return false;
              }
            } else {
              return true;              
            }
          }
        );

        // Add event listeners to the two range filtering inputs
        $("#fini").blur(function () {
          table.draw();
        });
        $("#ffin").blur(function () {
          table.draw();
        });

        $("#fesini").blur(function () {
          table.draw();
        });
        $("#fesfin").blur(function () {
          table.draw();
        });

        $("#finini").blur(function () {
          table.draw();
        });
        $("#finfin").blur(function () {
          table.draw();
        });

        $("#fbaini").blur(function () {
          table.draw();
        });
        $("#fbafin").blur(function () {
          table.draw();
        });

        $("#fomini").blur(function () {
          table.draw();
        });
        $("#fomfin").blur(function () {
          table.draw();
        });

        $("#cpini").keyup(function () {
          table.draw();
        });
        $("#cpfin").keyup(function () {
          table.draw();
        });

        $("#fSGEsini").blur(function () {
          table.draw();
        });
        $("#fSGEsfin").blur(function () {
          table.draw();
        });

        $("#fgoini").blur(function () {
          table.draw();
        });
        $("#fgofin").blur(function () {
          table.draw();
        });

        $("#fmaini").blur(function () {
          table.draw();
        });
        $("#fmafin").blur(function () {
          table.draw();
        });

        $("#fmaeini").blur(function () {
          table.draw();
        });
        $("#fmaefin").blur(function () {
          table.draw();
        });

        $("#fmbini").blur(function () {
          table.draw();
        });
        $("#fmbfin").blur(function () {
          table.draw();
        });

        $(".datepicker").datetimepicker({
          format: "DD/MM/YYYY",
          icons: {
            time: "fa fa-clock-o",
            date: "fa fa-calendar",
            up: "fa fa-chevron-up",
            down: "fa fa-chevron-down",
            previous: "fa fa-chevron-left",
            next: "fa fa-chevron-right",
            today: "fa fa-screenshot",
            clear: "fa fa-trash",
            close: "fa fa-remove",
            inline: true,
          },
          collapse: false,
        });

        $("#resetearFiltros").on("click", function () {
          $("#resetRegionesBtn").trigger("click");
          $("#resetDepartamentosBtn").trigger("click");
          $("#resetEstudiosBtn").trigger("click");
          $("#resetAltasBtn").trigger("click");
          $("#resetBajasBtn").trigger("click");
          $("#resetOmamoriBtn").trigger("click");

          $("#fini").val("");
          $("#ffin").val("");
          $("#fesini").val("");
          $("#fesfin").val("");
          $("#finini").val("");
          $("#finfin").val("");
          $("#fbaini").val("");
          $("#fbafin").val("");
          $("#fomini").val("");
          $("#fomfin").val("");
          $("#cpini").val("");
          $("#cpfin").val("");
          $("#fSGEsini").val("");
          $("#fSGEsfin").val("");
          $("#fgoini").val("");
          $("#fgofin").val("");
          $("#fmaini").val("");
          $("#fmafin").val("");
          $("#fmaeini").val("");
          $("#fmaefin").val("");
          $("#fmbini").val("");
          $("#fmbfin").val("");
          $("#cbGohonzon").prop("checked", false)

          aplicarFiltroInicial();

          table.draw();
        });
      });
    </script>
    {% endblock %} {% block extra_js %}
    <!--  DataTables.net Plugin    -->
    <script src="{% static 'gestion/js/jquery.datatables.js' %}"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.20/sorting/intl.js"></script>

    <script src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    {% endblock %}
  </div>
</div>
